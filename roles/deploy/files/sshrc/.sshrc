#!/usr/bin/env bash
# /!\ This script is copied over at each ssh connexion
# Therefore, it must stay as small and simple as possible
# NB : This file has to stay compatible both with bash and zsh
# TODO : Use the templating system to "Compile" only the
# strict necessary at deploy-time
# See https://github.com/Russell91/sshrc

# Check if the globalrc is installed, if so, abort everything
# /!\ The location is currently not configurable
if [ -d .globalrc ]; then
  echo "SSHRC disabled because GLOBALRC present"
  return 0
fi

# If we are running bash, but zsh is installed, switch to zsh
# TODO : we should not hardcode this path
if [[ $SHELL =~ 'bash' && -x '/usr/bin/zsh' ]]; then
  export ZDOTDIR="$SSHHOME/.sshrc.d"
  export SHELL='/usr/bin/zsh' # Why the hell do we need to do that ?!
  exec zsh
fi

# If we are running zsh, source the normal startup files
if [[ $SHELL =~ 'zsh' ]]; then
  # TODO : Conditionally load these
  # NB : This is currently loaded from a .zshrc file, so some tests are redundant
  # We could probably either load it from a .zprofile file, or remove some
  #export ZDOTDIR=''
  if [[ -e $HOME/.zshenv ]]; then
    source ~/.zshenv
  fi
  if [[ -e $HOME/.zprofile && -o login ]]; then
    source ~/.zprofile
  fi
  if [[ -e $HOME/.zshrc && -o interactive ]]; then
    source ~/.zshrc
  fi
  if [[ -e $HOME/.zlogin && -o login ]]; then
    source ~/.zlogin
  fi
fi

# keep an easy access to the original tmux, just in case
alias tmux_vanilla="$(which tmux)"

# Overload the tmux command to load sshrc
tmuxrc() {
  local TMUXDIR="/tmp/tmux-sshrc-$USER"
  if ! [ -d $TMUXDIR ]; then
    rm -rf $TMUXDIR
    mkdir -p $TMUXDIR
  fi
  rm -rf $TMUXDIR/.sshrc.d
  cp -r $SSHHOME/.sshrc $SSHHOME/bashsshrc $SSHHOME/sshrc $SSHHOME/.sshrc.d $TMUXDIR
  SSHHOME=$TMUXDIR SHELL=$TMUXDIR/bashsshrc /usr/bin/tmux -S $TMUXDIR/tmuxserver $@
}

# Load the readline settings
export INPUTRC="$SSHHOME/.sshrc.d/inputrc"
